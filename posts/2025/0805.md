---
title: build上传后访问404页面时卡loading的解决 nginx
tags: [debug]
categories: [搭建过程中遇到的问题]
date: 2025-08-05
description: 解决项目在生产环境中404页面卡在loading界面的问题，涉及SPA路由与静态文件服务的配置冲突
articleGPT: 生产环境下 404 页面卡在 loading，原因是 Nginx 直接返回了 404.html，导致 Vue 应用未启动，loading 无法关闭。解决办法是在 Nginx 配置中用 try_files $uri $uri/ /index.html;，让所有路由都回退到 SPA 入口，由前端路由处理 404。
---

## 问题描述

在将项目部署到生产环境后,访问不存在的页面时,404页面会卡在loading界面,无法正常显示404错误页面。但在开发环境中,404页面能够正常工作。

## 问题现象

- **开发环境**：`pnpm dev` 运行时,访问不存在页面能正常显示404页面
- **生产环境**：`pnpm build` 构建后部署,访问不存在页面卡在loading动画
- **静态资源**：资源文件都存在且正常

## 技术原理分析

### 问题的根本原因

这个问题源于**单页应用(SPA)架构**与**静态文件服务**之间的冲突：

#### VitePress的性质
- **构建时**：生成静态HTML文件，包括 `404.html`
- **运行时**：作为Vue SPA应用运行,依赖JavaScript进行路由管理

#### Loading机制工作流程

**正常流程（开发模式）：**
```
访问不存在页面 → 开发服务器返回index.html → Vue应用启动 → 
路由检测404 → 触发routeChange("before") → 显示loading → 
渲染NotFound组件 → 触发routeChange("after") → 清除loading
```

**问题流程（生产模式）：**
```
访问不存在页面 → nginx返回静态404.html → 
页面包含loading的HTML → Vue应用未启动 → 
routeChange函数无法执行 → loading状态永远无法清除
```

### 分析

#### App.vue中的loading控制
```vue
<main :class="['mian-layout', { loading: loadingStatus }]">
  <NotFound v-if="page.isNotFound" />
</main>
```
当 `loadingStatus` 为true时，主内容区域被隐藏

#### initTools.mjs状态管理
```javascript
const changeLoading = (option = {}) => {
  const store = mainStore();
  store.loadingStatus = status;
  // 随机延时结束loading
  loadingTimer = setTimeout(() => {
    store.loadingStatus = false;
  }, Math.floor(Math.random() * (800 - 260 + 1)) + 260);
};
```

#### 路由守卫
```javascript
router.onBeforeRouteChange = (to) => {
  routeChange("before", to);
};
router.onAfterRouteChanged = (to) => {
  routeChange("after", to);
};
```

## 解决方案

### Nginx配置添加SPA路由,确保所有路由都回退到SPA入口

修改nginx配置文件，添加SPA路由支持：

```nginx
server {
    location / {
        try_files $uri $uri/ /index.html;
    }
}
```
- `try_files $uri $uri/ /index.html;` 确保所有路由都回退到SPA入口,根据路由渲染对应页面或404页面

### 验证
访问一个不存在的页面,如：`https://your-domain.com/bilibili`,观察是否渲染404Notfound